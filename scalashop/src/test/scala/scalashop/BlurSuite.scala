package scalashop

import java.util.concurrent._
import scala.collection._
import org.junit._
import org.junit.Assert.assertEquals

class BlurSuite extends munit.FunSuite {
    val arr3x3 = Array(48756475,348845,148700,444685,45748,474847,484,48564, 84765)
    val arr3x3_cp1 = arr3x3.clone
    val arr3x3_cp2 = arr3x3.clone
    val arr3x3_cp3 = arr3x3.clone
    val arr32x32 = Array(
217476672 , 1220832286 , 1427995877 , 98136791 , 1960133563 , 1675110022 , 511362270 , 1372111772 , 1554595373 , 895165760 , 1170573331 , 1334622922 , 757532878 , 664759517 , 898220261 , 1821870147 , 1020920951 , 293084898 , 244251012 , 1931224338 , 1689388544 , 1748665806 , 260934702 , 671244729 , 8673444 , 480341471 , 1833468289 , 995075903 , 1813663135 , 599382030 , 823505924 , 253947441 , 
44367380 , 1463791396 , 162738109 , 1827241182 , 473591822 , 885745021 , 1667906836 , 1074050886 , 438450776 , 392839175 , 944081877 , 983004251 , 1802780426 , 1414731289 , 442029841 , 582346049 , 732760670 , 1697682411 , 984110475 , 642984616 , 1093121545 , 489708514 , 1801695591 , 567101787 , 1033737941 , 403305416 , 1134184288 , 1975752777 , 1654977598 , 1519662723 , 674481671 , 1348206576 , 
708179194 , 1928741596 , 1898712030 , 1241707587 , 737869877 , 396531986 , 401055778 , 1221839903 , 907007305 , 254819706 , 790756985 , 1436003466 , 1809804335 , 82571762 , 853928961 , 1047713977 , 1802535196 , 1255054637 , 1761102567 , 1358287734 , 697048118 , 1917736104 , 1619183807 , 789793455 , 1250536722 , 1942999408 , 933922784 , 1275072693 , 658030833 , 638845915 , 1961422386 , 1628889681 , 
1533630430 , 1160457304 , 566235886 , 994056544 , 1125417385 , 342947468 , 183776078 , 932197750 , 611615693 , 1427818946 , 74024656 , 751289700 , 246164468 , 290598914 , 523491631 , 1317074114 , 419887785 , 1211168378 , 498601835 , 1665181108 , 1206447471 , 1623332869 , 1419827023 , 1368828274 , 139268742 , 997423711 , 403501822 , 731157353 , 1632073920 , 1760704611 , 757050291 , 1008090449 , 
886265774 , 1651403799 , 168555715 , 1315940763 , 469642675 , 1534093088 , 328365189 , 1611571363 , 1597740713 , 468516470 , 1378977961 , 1715047805 , 8064264 , 1385215841 , 1600607260 , 374373287 , 1956084728 , 1561958207 , 1628896390 , 1500188524 , 1094525415 , 767286798 , 681398245 , 1677730842 , 527986297 , 1447071296 , 809882275 , 1215521021 , 604542252 , 1455052584 , 1149321198 , 812365120 , 
1426021523 , 123223320 , 1091205616 , 817726187 , 468024645 , 169146399 , 1670108820 , 1759122499 , 102536260 , 1629213610 , 640237580 , 982833560 , 1580956376 , 315092211 , 369715854 , 727136863 , 571566465 , 1558540220 , 1205862014 , 1118073129 , 582285935 , 1368382412 , 125962233 , 972104019 , 63237491 , 997106079 , 1895046794 , 1564896390 , 1653804633 , 181034776 , 676820175 , 225435200 , 
1032238082 , 754396502 , 730601742 , 1468621329 , 1085906889 , 1177530926 , 3623853 , 749421972 , 1241222777 , 356429012 , 1414443601 , 1794268899 , 1514656988 , 973635297 , 1329735100 , 497955120 , 1316285632 , 440978739 , 763950770 , 1670171310 , 38063396 , 1231363140 , 1342933999 , 131290920 , 1792736023 , 1580360535 , 385125455 , 1469280836 , 1295206525 , 494418810 , 1255996654 , 703397616 , 
13727315 , 1104777380 , 1958785991 , 1654792642 , 169373820 , 784921254 , 1114329821 , 1169385445 , 1014866875 , 1126703638 , 1469523638 , 993423294 , 1070090448 , 1121457272 , 927815974 , 480681508 , 772949425 , 540641124 , 1971560346 , 1620949082 , 174223469 , 1585988751 , 1121677977 , 349416760 , 1625351724 , 1637732401 , 458654649 , 1985082246 , 672886368 , 959934875 , 1806382578 , 504630925 , 
1870645634 , 261256858 , 735907774 , 1763573479 , 1988928057 , 15517030 , 187746405 , 1733638003 , 596312095 , 822086987 , 736035425 , 319635887 , 1813171318 , 758366575 , 240473421 , 1232681741 , 1260858693 , 1217951301 , 1226283316 , 119381054 , 650051626 , 1037131855 , 1415178529 , 1997496334 , 916850724 , 79243642 , 1610700999 , 555103795 , 1347840709 , 146897210 , 87721178 , 1618814573 , 
791399373 , 512786260 , 179000806 , 872986962 , 1607389497 , 1223157694 , 460218254 , 1278745301 , 134177332 , 243656217 , 893567010 , 817099110 , 405070394 , 1915819914 , 1801307231 , 1197077650 , 1792504190 , 1228881176 , 574525174 , 955333970 , 964346129 , 1445975111 , 1274878311 , 309767583 , 799959982 , 398728916 , 1280735954 , 1688252123 , 1758886087 , 235917282 , 607589200 , 711990033 , 
1612319876 , 107695926 , 1895638988 , 269117099 , 1733318473 , 118834849 , 1312375145 , 1895860723 , 1577332015 , 1368492709 , 81325227 , 1887905235 , 479223819 , 1678197805 , 425220285 , 495086226 , 224953922 , 1672575088 , 1315235472 , 483619075 , 1193663775 , 831974198 , 193897756 , 248671985 , 837746394 , 1829441183 , 1578360176 , 1115211148 , 568103150 , 557065968 , 1774744782 , 618421692 , 
3332324 , 1766799692 , 1708304448 , 25117139 , 991980026 , 105170840 , 1338312766 , 1663797786 , 841019304 , 8180959 , 1878456276 , 895052072 , 382542596 , 429561137 , 35062263 , 323830922 , 641525727 , 1302047287 , 720455080 , 1028712976 , 61822658 , 45811454 , 1751707797 , 1717582667 , 1907685037 , 733168243 , 1108471720 , 965342310 , 102541610 , 569899199 , 294277031 , 1242702609 , 
1099633277 , 770428570 , 880398540 , 910709063 , 1435623147 , 704434742 , 253901341 , 1084269042 , 1139368119 , 619060955 , 217698573 , 1656423316 , 1346231937 , 377192763 , 1005642977 , 1859715376 , 1737895195 , 155562615 , 67592533 , 830118010 , 857678650 , 1910417286 , 794385055 , 1112005351 , 1093115161 , 1695659155 , 1779703833 , 757248910 , 221309357 , 492995687 , 695145306 , 1424001289 , 
8210587 , 1270698476 , 1563943579 , 633823412 , 370786607 , 1003589177 , 445476709 , 1668600122 , 228663754 , 501031627 , 39713332 , 1902399118 , 1985924830 , 1868552158 , 107392351 , 768719908 , 272017469 , 1575949157 , 432598264 , 1117347175 , 1719972840 , 1263532719 , 387768680 , 1176072733 , 1563564815 , 946891903 , 1378280229 , 1576914720 , 1275640026 , 1877439181 , 1844028071 , 468599043 , 
1536486799 , 733388325 , 1166264748 , 1934811056 , 164732332 , 1091238958 , 977390457 , 247867479 , 710737849 , 1378246824 , 1031007727 , 371151057 , 898333633 , 482619224 , 1984093492 , 866296433 , 274528186 , 834343563 , 582970526 , 1798239355 , 702674747 , 1892203278 , 1328662315 , 1334770126 , 1189884848 , 452964641 , 1521771715 , 786951 , 1301093605 , 554369142 , 1515807646 , 36176152 , 
95320323 , 1916558142 , 1706484244 , 964005430 , 771936725 , 1449322869 , 485048192 , 30570320 , 1649947351 , 1890618898 , 458412496 , 1810709700 , 1256779973 , 383080674 , 161255686 , 994746929 , 1531313451 , 1467796707 , 1644400720 , 1182646054 , 1659809392 , 1087612494 , 922088374 , 1340923347 , 771409154 , 1221873100 , 27632002 , 465364863 , 615687581 , 662854180 , 1016827929 , 958516608 , 
873011474 , 1794507174 , 62183253 , 1035144387 , 815157736 , 1013212944 , 379373511 , 1478796063 , 334831864 , 242120796 , 897374478 , 1647273746 , 1416301802 , 1679037504 , 886775098 , 380789627 , 1564817796 , 152132422 , 1493538795 , 1673674830 , 1542987181 , 255566195 , 1277299794 , 1164433709 , 353284870 , 1191053392 , 466942136 , 591025411 , 1882209332 , 93501865 , 1883946845 , 1432551864 , 
67157632 , 393214491 , 1418448680 , 331817345 , 1573936155 , 1597315477 , 1717636535 , 512312315 , 676603134 , 476196660 , 1333130222 , 854037864 , 1238313624 , 1195333119 , 1002835670 , 438294293 , 1398066866 , 783430728 , 1916167002 , 678864833 , 1072586455 , 129596694 , 1696766618 , 1333553125 , 803433967 , 1085777279 , 1188663349 , 335743562 , 1883760230 , 1978891999 , 74435900 , 543253490 , 
1306583388 , 1229642578 , 1517571041 , 1970632168 , 15945152 , 167500227 , 33933245 , 670473349 , 1462555073 , 1731810998 , 1844567930 , 1449366604 , 1182942424 , 1365829710 , 1446813227 , 1978885286 , 239335217 , 472426176 , 547650989 , 1411691334 , 1599543698 , 579041749 , 1800603410 , 1808416481 , 75705530 , 1662261658 , 410694226 , 119281927 , 973421994 , 688842751 , 1006981370 , 604919509 , 
872616994 , 642382493 , 271070374 , 1769453399 , 517496981 , 914570140 , 1081241343 , 1136118953 , 872279870 , 1786661691 , 1986023884 , 542992771 , 1031372545 , 773156896 , 1635725938 , 1181783597 , 324474290 , 1151755331 , 1354567716 , 531971500 , 1497860138 , 1818347676 , 788127297 , 74367621 , 1304274514 , 992913598 , 1615703060 , 1235925209 , 1022246325 , 1696670505 , 588136681 , 1372652673 , 
1175023567 , 273994066 , 1931423414 , 9066863 , 570076509 , 1653790078 , 996775445 , 1369472384 , 213394261 , 285942047 , 1889133264 , 378606130 , 1718065835 , 1051796234 , 1492166863 , 1502615715 , 364501153 , 1342704350 , 844791599 , 1439603959 , 1902083691 , 1985285689 , 757913708 , 1730821534 , 696748949 , 697534285 , 1576875896 , 202668218 , 1277896875 , 172580070 , 586287607 , 583463234 , 
903726955 , 1335618602 , 99019847 , 226514822 , 1003540031 , 75069887 , 958654966 , 910723206 , 1765106816 , 149155618 , 703448213 , 149439448 , 1254426434 , 1407443440 , 94125793 , 570774584 , 1783475676 , 1030655107 , 122497721 , 1909423268 , 975209866 , 304959526 , 984901111 , 214263700 , 494077226 , 81713003 , 774160539 , 1221761275 , 985033293 , 1399257472 , 978725853 , 1388402969 , 
1198105899 , 39239111 , 884595313 , 71645616 , 207193696 , 1261653023 , 529762794 , 510309417 , 1377194759 , 439898678 , 1560004345 , 1854684907 , 202178655 , 1849508816 , 702044135 , 1356711415 , 240796496 , 839910082 , 564243329 , 1003269026 , 358964303 , 1061809222 , 1329365582 , 1145267005 , 643493348 , 285997686 , 365750356 , 1763831024 , 651003008 , 139185320 , 481484319 , 1587796973 , 
1873311250 , 1957394035 , 593457957 , 1017678954 , 1565336189 , 484397654 , 1212416600 , 332757420 , 324583212 , 660459288 , 652099726 , 70888359 , 1648538387 , 409914874 , 1581164191 , 46409009 , 1634845870 , 148912506 , 107395569 , 1103267437 , 585691837 , 656082204 , 1553162283 , 1099391396 , 1474062939 , 1520568605 , 69270181 , 1570813079 , 1445134663 , 1838443609 , 1645083237 , 1425658941 , 
653606086 , 155573895 , 844788546 , 1106458563 , 1865634897 , 270973802 , 1283406353 , 959554401 , 1930054848 , 254889281 , 1876530120 , 496794790 , 839639107 , 857798447 , 188071488 , 1887578596 , 205450856 , 104251999 , 539873127 , 19803946 , 9090194 , 106392393 , 772564074 , 1561877772 , 1752416965 , 496181726 , 1655137066 , 1288983879 , 1750040665 , 168451046 , 1324090451 , 1132770030 , 
704738093 , 1851342746 , 1615507322 , 1154119168 , 272243896 , 1900661490 , 1207781909 , 1072341769 , 1893409844 , 1359147452 , 1503245602 , 1220939293 , 233348274 , 475136572 , 476887564 , 1290846452 , 22140129 , 894280790 , 1285380695 , 556159292 , 1114805072 , 147159479 , 1243147353 , 1479601592 , 1203188661 , 452432496 , 1692886144 , 1331745039 , 1344764531 , 1087205930 , 87485987 , 778129068 , 
1557391346 , 450061563 , 829439347 , 894704055 , 786952960 , 1391899861 , 793209663 , 367378136 , 893351678 , 1019550652 , 1642645807 , 317418193 , 1382414822 , 1914456204 , 384026069 , 766294618 , 1653571213 , 1649836635 , 1411298245 , 286825700 , 952629252 , 1957576865 , 93015581 , 579294504 , 1338399666 , 59354577 , 1504131153 , 1495993045 , 1214959831 , 1807611648 , 1839623603 , 1032346311 , 
923605418 , 1884575099 , 997676040 , 1689044593 , 866204538 , 424250888 , 1418397313 , 1976788788 , 1607435642 , 857552917 , 266694086 , 253648934 , 1968979285 , 328061555 , 1560162290 , 480415244 , 1358361095 , 1050541071 , 32687612 , 463986511 , 1954916962 , 96746093 , 1629274290 , 1784538373 , 1133511430 , 944384937 , 770582995 , 1258639650 , 380818988 , 1884367337 , 1317664555 , 1213362759 , 
812425264 , 1465338659 , 1024589583 , 1981774855 , 1669793984 , 208784259 , 15122777 , 589775350 , 722408053 , 802888250 , 399237060 , 1484909296 , 1898408413 , 111040229 , 1450427764 , 645039630 , 341504345 , 307389727 , 1527849718 , 214578135 , 1852487079 , 257867133 , 919168712 , 650301868 , 1281747655 , 901209180 , 130564503 , 1774565628 , 1722285877 , 440046957 , 1813923211 , 731746563 , 
1278802946 , 1080189524 , 968191247 , 491048279 , 579911410 , 1326457945 , 690952209 , 1958841299 , 1974603392 , 825686480 , 886291056 , 468405104 , 681243589 , 1627992050 , 1204258023 , 1415331488 , 751231482 , 908432001 , 292733743 , 633880856 , 488245326 , 1994589378 , 777366310 , 461114387 , 1568471737 , 1555372866 , 666363642 , 31764836 , 299499047 , 903508267 , 1914340708 , 67112281 , 
366561268 , 1763267699 , 1802644543 , 1071200884 , 1308589598 , 1888798037 , 1837557293 , 473276740 , 1239290994 , 1453697470 , 651795991 , 143883358 , 158753676 , 549593523 , 649240383 , 250736801 , 168185755 , 1574170421 , 1171855913 , 778710647 , 1212962607 , 1164047048 , 1329672831 , 211645451 , 259586121 , 104684635 , 1044604044 , 722138325 , 656069336 , 368828727 , 29024715 , 1046394590 , 
800423811 , 311403109 , 1172503800 , 1305090123 , 1331299305 , 1227004235 , 619153587 , 663265384 , 1389097014 , 1230491291 , 1442914583 , 210237514 , 1496915488 , 683293744 , 1203900925 , 225487786 , 37359750 , 824034204 , 424884255 , 1808326332 , 1229594909 , 1020625660 , 938991410 , 293043357 , 1776035677 , 139060399 , 356517516 , 822575214 , 973655637 , 10973039 , 1298145816 , 624405139
   )
    val arr32x32_cp1 = arr32x32.clone
    val arr32x32_cp2 = arr32x32.clone
    val arr32x32_cp3 = arr32x32.clone
    var tasks = 5
    var radius = 5
    val img3x3 = new Img(3, 3, arr3x3)
    val dst3x3 = new Img(3, 3, arr3x3_cp1)
    val img3x3_cp1 = new Img(3, 3, arr3x3_cp3)
    val dst3x3_cp1 = new Img(3, 3, arr3x3_cp3)

    val img32x32 = new Img(32, 32, arr32x32)
    val dst32x32 = new Img(32, 32, arr32x32_cp1)
    val img32x32_cp1 = new Img(32, 32, arr32x32_cp2)
    val dst32x32_cp1 = new Img(32, 32, arr32x32_cp3)

    val img3x4 = new Img(3, 4, Array(1,2,3,4,5,6,7,8,9,10,11,12))

    test("Blur should modify each pixel of 32x32 image") {
      assert(pixelArrEqual(img32x32, arr32x32))
      HorizontalBoxBlur.parBlur(img32x32, dst32x32, tasks, radius)
      assert(allPixesAreModified(dst32x32, arr32x32))
      VerticalBoxBlur.parBlur(img32x32_cp1, dst32x32_cp1, tasks, radius)
      assert(allPixesAreModified(dst32x32_cp1, arr32x32))
    }

    test("Correctly blur 3x3 image") {
      radius = 1
      tasks = 4
      assert(pixelArrEqual(img3x3, arr3x3))
      HorizontalBoxBlur.parBlur(img3x3, dst3x3, tasks, radius)
      assert(allPixesAreModified(dst3x3, arr3x3))
      VerticalBoxBlur.parBlur(img3x3_cp1, dst3x3_cp1, tasks, radius)
      assert(allPixesAreModified(dst3x3_cp1, arr3x3))
    }

    test("BoxBlurKernel is correct") {
      radius = 1
      tasks = 2
      val rgbaComputed = boxBlurKernel(img3x4, 1, 2, radius)
      var r, g, b, a = 0
      val rgbas = for {
        x <- 0 to 2
        y <- 1 to 3
      } yield (x, y)
      rgbas.foreach {
          pair => {
            val pixel =img3x4(pair._1, pair._2)
            r += red(pixel); g += green(pixel); b += blue(pixel); a += alpha(pixel)
          }
      }
      assert( rgba(r/9, g/9, b/9, a/9) == rgbaComputed)
    }

      test("Handle 0 radius correctly") {
        radius = 0
        tasks = 5
        val rgbaComputed = boxBlurKernel(img3x3, 1, 1, radius)
        assert(rgbaComputed == img3x3(1, 1))
      }

      // HorizontalBoxBlur.parBlur(img3x3, dst3x3, tasks, radius)
      // assert(! allPixesAreModified(dst3x3, arr3x3))

    def pixelArrEqual(img: Img, arr: Array[Int]): Boolean = {
      assert(img.width * img.height == arr.length)
      arr.zip(0 until arr.length).foreach {
        pair => {
          val idx = pair._2; val rgba = pair._1; val y = idx / img.width; val x = idx % img.width
          if (! (img(x,y) == rgba)) return false
        }
      }
      true
    }

    def allPixesAreModified(img: Img, arr: Array[Int]): Boolean = {
      assert(img.width * img.height == arr.length)
      arr.zip(0 until arr.length).foreach {
        pair => {
          val idx = pair._2; val rgba = pair._1; val y = idx / img.width; val x = idx % img.width
          if (img(x,y) == rgba) return false
        }
      }
      true
    }
}
